<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Refresh page every 900 seconds (15 minutes) -->
    <meta http-equiv="refresh" content="900">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16x16.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">

    <title>{{ node_alias }} - Status</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

    <style>
        .small-muted{font-size:.9rem;opacity:.8}
    </style>
</head>

<body class="dark">
<div class="container">

    <!-- Hora atual -->
    <div id="current-time" class="text-right"></div>

    <!-- Marquee CoinGecko -->
    <script src="https://widgets.coingecko.com/gecko-coin-price-marquee-widget.js"></script>
    <gecko-coin-price-marquee-widget
        locale="en"
        outlined="true"
        coin-ids="bitcoin,bitcoin,tether,ethereum"
        vs-currencies="usd,brl,xau,eur,usd">
    </gecko-coin-price-marquee-widget>

    <h1 class="mt-5">{{ node_alias }} - Node Status</h1>

    <div class="alert alert-info" role="alert">{{ message | safe }}</div>

    <!-- Fee Info -->
    <div class="alert alert-secondary" role="alert">
        <strong>üöÄ Fastest Fee: {{ fee_info.fastestFee }} sat/vB</strong> |
        üöó Half Hour Fee: {{ fee_info.halfHourFee }} sat/vB |
        üõµ Hour Fee: {{ fee_info.hourFee }} sat/vB |
        üö≤ Economy Fee: {{ fee_info.economyFee }} sat/vB |
        üêå Minimum Fee: {{ fee_info.minimumFee }} sat/vB
        <div class="small-muted mt-1">
            üîé Fonte: {{ fee_info.get('_source','desconhecida') }}
        </div>
    </div>

    <h2 class="mt-4">Bitcoin Core (bitcoind) - {{ bitcoind.bitcoind }}</h2>
    <ul class="list-group">
        <li class="list-group-item">
            <strong>Sync Percentage:</strong>
            <span class="{% if bitcoind.sync_percentage >= 99.99 %}green{% else %}yellow{% endif %}">
                {{ '100.00' if bitcoind.sync_percentage >= 99.99 else '%.2f' % bitcoind.sync_percentage }}%
            </span> |
            <strong>Version:</strong> {{ bitcoind.version }} - {{ bitcoind.subversion }} |
            <strong>Chain:</strong> {{ bitcoind.chain }}
        </li>
        <li class="list-group-item">
            <strong>Current Block Height:</strong> {{ bitcoind.current_block_height }} |
            <strong>Number of Peers:</strong> {{ bitcoind.number_of_peers }} |
            <strong>Pruned:</strong> {{ bitcoind.pruned }}
        </li>
    </ul>

    <h2 class="mt-4">Lightning Network Daemon (lnd)</h2>
    <ul class="list-group">
        <li class="list-group-item"><strong>LND Version:</strong> {{ lnd.node_lnd_version }}</li>
        <li class="list-group-item"><strong>Public Key:</strong> {{ lnd.pub_key }}</li>
        <li class="list-group-item">
            <strong>Sync Status:</strong>
            <strong>Chain:</strong>
            <span class="{% if lnd.synced_to_chain %}green{% else %}yellow{% endif %}">
                {{ lnd.synced_to_chain }}
            </span> |
            <strong>Graph:</strong>
            <span class="{% if lnd.synced_to_graph %}green{% else %}yellow{% endif %}">
                {{ lnd.synced_to_graph }}
            </span>
        </li>
        <li class="list-group-item">
            <strong>Total Balance:</strong> {{ '{:,.0f}'.format(lnd.total_balance) }} satoshis |
            <strong>Wallet Balance:</strong> {{ '{:,.0f}'.format(lnd.wallet_balance) }} satoshis |
            <strong>Channels Balance:</strong> {{ '{:,.0f}'.format(lnd.channel_balance) }} satoshis
        </li>
        <li class="list-group-item"><strong>Number of Channels:</strong> {{ lnd.number_of_channels }}</li>
        <li class="list-group-item">
            <strong>Number of Active Channels:</strong> {{ lnd.num_active_channels }} |
            <strong>Number of Inactive Channels:</strong> {{ lnd.num_inactive_channels }} |
            <strong>Number of Pending Channels:</strong> {{ lnd.num_pending_channels }}
        </li>
        <li class="list-group-item"><strong>Number of Peers:</strong> {{ lnd.number_of_peers }}</li>
    </ul>

    <!-- Off-chain Profit Panel (jvx + lnd_fees.sqlite) -->
    <h3 class="mt-4 d-flex justify-content-between align-items-center">
        <span>‚ö° Lucro Off-Chain</span>
        <button id="profit-refresh" class="btn btn-sm btn-outline-light" title="Atualizar lucro">‚Üª</button>
    </h3>
    <ul class="list-group" id="profit-block">
        <li class="list-group-item">Carregando dados de lucro...</li>
    </ul>

    <!-- Top Peers -->
    <h3 class="mt-4 d-flex justify-content-between align-items-center">
        <span>
            üë• Top Peers (√∫ltimos <span id="tp-window">30</span> dias)
        </span>
        <div class="d-flex align-items-center">
            <div class="btn-group btn-group-sm me-2" role="group" aria-label="Janela Top Peers">
                <button type="button" class="btn btn-outline-light tp-range" data-days="7">7d</button>
                <button type="button" class="btn btn-outline-light tp-range active" data-days="30">30d</button>
                <button type="button" class="btn btn-outline-light tp-range" data-days="90">90d</button>
            </div>
            <button id="top-peers-refresh" class="btn btn-sm btn-outline-light" title="Atualizar ranking de peers">‚Üª</button>
        </div>
    </h3>

    <div class="mt-2" id="top-peers-block">
        <div class="list-group">
            <div class="list-group-item">Carregando ranking de peers...</div>
        </div>
    </div>

    <h2 class="mt-4">System Information</h2>
    <ul class="list-group">
        <li class="list-group-item">
            <strong>CPU Usage:</strong> {{ system_info.cpu_usage }}% |
            <strong>CPU Temp:</strong>
            <span class="{% if system_info.cpu_temp > 85 %}red{% elif system_info.cpu_temp > 65 %}yellow{% else %}green{% endif %}">
                {{ system_info.cpu_temp }} ¬∞C
            </span> |
            <strong>Memory Usage:</strong> {{ system_info.memory_usage }}%
        </li>
        <li class="list-group-item">
            <strong>CPU Name:</strong> {{ system_info.cpu_info['brand_raw'] }} |
            <strong>Architecture:</strong> {{ system_info.cpu_info['arch'] }}
        </li>
    </ul>

    <h3 class="mt-4">Physical Disks Usage</h3>
    <ul class="list-group">
        {% for device, usage in system_info.physical_disks_usage.items() %}
        <li class="list-group-item">
            <strong>Device:</strong> {{ device }},
            <strong>Total:</strong> {{ (usage.total / (1024**3))|round(2) }} GB,
            <strong>Used:</strong> {{ (usage.used / (1024**3))|round(2) }} GB,
            <strong>Free:</strong> {{ (usage.free / (1024**3))|round(2) }} GB,
            <strong>Usage:</strong> {{ usage.percent|round(1) }}%
        </li>
        {% endfor %}
    </ul>

</div>

<!-- Buttons -->
<button class="theme-switch btn btn-primary">Toggle Theme</button>
<button class="pay-invoice btn btn-primary">Pay Invoice</button>
<button class="new-invoice btn btn-primary">New Invoice</button>
<button class="lnd-logs btn btn-primary">LND Logs</button>

<!-- Modais e demais templates -->
{% include 'message.txt' %}

<!-- JS libs -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
/* ===========================
   THEME SWITCH
=========================== */
const themeSwitch = document.querySelector('.theme-switch');
const body = document.querySelector('body');
if (themeSwitch) {
    themeSwitch.addEventListener('click', () => {
        if (body.classList.contains('dark')) {
            body.classList.remove('dark');
            body.classList.add('light');
        } else {
            body.classList.remove('light');
            body.classList.add('dark');
        }
    });
}

/* ===========================
   ‚ö° OFF-CHAIN PROFIT (jvx)
=========================== */
(function () {
    const block = document.getElementById('profit-block');
    const btn   = document.getElementById('profit-refresh');
    if (!block) return;

    function fmtPlain(v) {
        return Number(v || 0).toLocaleString('pt-BR');
    }
    function fmtColored(v) {
        const n = Number(v || 0);
        return `<span class="${n >= 0 ? 'text-success' : 'text-danger'}">${fmtPlain(n)} sats</span>`;
    }
    function fmtMonth(m) {
        if (!m) return '';
        const [y, M] = m.split('-');
        return `${M}/${y}`;
    }

    async function loadProfit() {
        try {
            block.innerHTML = `<li class="list-group-item">Carregando...</li>`;
            const res = await fetch('/lnd-fees');
            const data = await res.json();

            if (!res.ok || data.error) {
                throw new Error(data.error || `HTTP ${res.status}`);
            }

            const last = data.last_day || null;
            const monthly = Array.isArray(data.monthly) ? data.monthly : [];
            const ytd = Number(data.year_to_date || 0);

            let html = '';

            if (last && last.date) {
                const [yy, mm, dd] = last.date.split('-');
                html += `<li class="list-group-item"><strong>Ontem (${dd}/${mm}/${yy}):</strong> ${fmtColored(last.profit)}</li>`;
                html += `<li class="list-group-item">Fees encaminhamento: ${fmtPlain(last.forwards)} sats</li>`;
                html += `<li class="list-group-item">Custo de rebalance: ${fmtPlain(last.rebalances)} sats</li>`;
            }

            const len = monthly.length;
            const cur = len >= 1 ? monthly[len - 1] : null;
            const prev = len >= 2 ? monthly[len - 2] : null;
            const others = len > 2 ? monthly.slice(Math.max(0, len - 5), len - 2) : [];

            html += `<li class="list-group-item"><strong>Comparativo mensal:</strong></li>`;
            if (cur) {
                html += `<li class="list-group-item">
                    M√™s atual (${fmtMonth(cur.month)}):
                    ${fmtColored(cur.profit)}
                    (fees=${fmtPlain(cur.forwards)}, rebalance=${fmtPlain(cur.rebalances)})
                </li>`;
            }
            if (prev) {
                html += `<li class="list-group-item">
                    M√™s anterior (${fmtMonth(prev.month)}):
                    ${fmtColored(prev.profit)}
                    (fees=${fmtPlain(prev.forwards)}, rebalance=${fmtPlain(prev.rebalances)})
                </li>`;
            }

            if (others.length) {
                html += `<li class="list-group-item"><strong>Resumo √∫ltimos meses (exceto atual/anterior):</strong></li>`;
                others.slice(-3).forEach(m => {
                    html += `<li class="list-group-item">
                        ‚Ä¢ ${fmtMonth(m.month)}:
                        ${fmtColored(m.profit)}
                        (fees=${fmtPlain(m.forwards)}, rebalance=${fmtPlain(m.rebalances)})
                    </li>`;
                });
            }

            html += `<li class="list-group-item"><strong>Lucro acumulado no ano (YTD):</strong> ${fmtColored(ytd)}</li>`;
            block.innerHTML = html;
        } catch (e) {
            console.error('Erro ao carregar lucro off-chain:', e);
            block.innerHTML = `<li class="list-group-item text-danger">Erro ao carregar lucro off-chain.</li>`;
        }
    }

    loadProfit();
    if (btn) {
        btn.addEventListener('click', (ev) => {
            ev.preventDefault();
            btn.disabled = true;
            loadProfit().finally(() => { btn.disabled = false; });
        });
    }
})();

/* ===========================
   üë• TOP PEERS (FORWARDS)
=========================== */
(function () {
    const block = document.getElementById('top-peers-block');
    const btn   = document.getElementById('top-peers-refresh');
    const windowSpan = document.getElementById('tp-window');
    const rangeButtons = document.querySelectorAll('.tp-range');

    if (!block) return;

    function fmt(n) {
        return Number(n || 0).toLocaleString('pt-BR');
    }

    let currentDays = 30;

    async function loadTopPeers(days) {
        try {
            block.innerHTML = `
                <div class="list-group">
                    <div class="list-group-item">Carregando ranking de peers...</div>
                </div>`;

            const res = await fetch(`/top-peers?days=${days}`);
            const data = await res.json();

            if (windowSpan) {
                windowSpan.textContent = data.window_days || days;
            }

            if (!res.ok || data.error) {
                throw new Error(data.error || `HTTP ${res.status}`);
            }

            const windowDays = data.window_days || days;
            const top = Array.isArray(data.top) ? data.top : [];
            const low = Array.isArray(data.low) ? data.low : [];

            if (!top.length && !low.length) {
                block.innerHTML = `
                    <div class="list-group">
                        <div class="list-group-item">
                            <strong>Janela analisada:</strong> √∫ltimos ${windowDays} dias.
                        </div>
                        <div class="list-group-item">
                            Sem eventos de encaminhamento no per√≠odo.
                        </div>
                    </div>`;
                return;
            }

            const topList = top.map((p, idx) => `
                <li>
                    <strong>${idx + 1}. ${p.alias}</strong> ‚Äî fees:
                    ${fmt(p.fees_sat)} sats,
                    volume roteado: ${fmt(p.amount_sat)} sats
                    (encaminhamentos: ${fmt(p.events)})
                </li>`).join('');

            const lowList = low.map((p, idx) => `
                <li>
                    <strong>${idx + 1}. ${p.alias}</strong> ‚Äî fees:
                    ${fmt(p.fees_sat)} sats,
                    volume roteado: ${fmt(p.amount_sat)} sats
                    (encaminhamentos: ${fmt(p.events)})
                </li>`).join('');

            block.innerHTML = `
                <div class="list-group">
                    <div class="list-group-item">
                        <p class="mb-1">
                            <strong>Janela analisada:</strong> √∫ltimos ${windowDays} dias.
                        </p>
                    </div>
                    <div class="list-group-item">
                        <p class="mb-1">
                            <strong>Top 5 peers por fee recebida:</strong>
                        </p>
                        <ol class="mb-0">
                            ${topList}
                        </ol>
                    </div>
                    <div class="list-group-item">
                        <p class="mb-1">
                            <strong>5 peers que menos geraram fee no per√≠odo (entre os ativos):</strong>
                        </p>
                        <ol class="mb-0">
                            ${lowList}
                        </ol>
                    </div>
                </div>`;
        } catch (e) {
            console.error('Erro ao carregar top peers:', e);
            block.innerHTML = `
                <div class="list-group">
                    <div class="list-group-item text-danger">
                        Erro ao carregar ranking de peers: ${e}
                    </div>
                </div>`;
        }
    }

    // Inicializa com 30 dias
    loadTopPeers(currentDays);

    // Bot√µes 7d / 30d / 90d
    rangeButtons.forEach(btnRange => {
        btnRange.addEventListener('click', () => {
            rangeButtons.forEach(b => b.classList.remove('active'));
            btnRange.classList.add('active');

            const days = parseInt(btnRange.dataset.days, 10) || 30;
            currentDays = days;
            loadTopPeers(days);
        });
    });

    // Bot√£o de refresh manual
    if (btn) {
        btn.addEventListener('click', (ev) => {
            ev.preventDefault();
            btn.disabled = true;
            loadTopPeers(currentDays).finally(() => { btn.disabled = false; });
        });
    }
})();

/* ===========================
   CLOCK
=========================== */
function updateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString();
    document.getElementById('current-time').textContent = `Current Time: ${timeString}`;
}
updateTime();
setInterval(updateTime, 1000);
</script>

</body>
</html>
